pipeline {
  agent {label 'inteliventi'}
  stages {
        stage("Checkout Git") {
            steps {
                git branch: 'prod', url: 'https://github.com/sergkharkin/jenkins-test.git' 
            }
        }
        stage("Update Wordpress") {
            steps {
                sh '''#!/bin/bash
                set -x
                START=$(date +%s)
                #Делаю бэкап базы
                docker exec -i mariadb1 mysqldump -u wordpress --password=wordpress wordpress > /home/user/wpdbdump$(date +%y%m%d%H%M%S).sql
                #Стопаю контейнеры
                docker stop mariadb1 wordpress1
                while (( ($(docker ps | grep -c mariadb1)+$(docker ps | grep -c wordpress1)) != 0 ))
                do
                  sleep 1
                done
                #Удаляю
                docker rm mariadb1 wordpress1
                #жду удаления
                while (( ($(docker ps -a | grep -c mariadb1)+$(docker ps -a | grep -c wordpress1)) != 0 ))
                do
                  sleep 1
                done
                #запускаю контейнеры
                docker compose -f wordpress-docker-compose.yml up -d
                #жду поднятия
                while (( ($(docker ps | grep -c mariadb1)+$(docker ps | grep -c wordpress1)) != 2 ))
                do
                  sleep 1
                done
                END=$(date +%s)
                DIFF=$(( $END - $START ))
                echo "Обновление заняло " $DIFF " секунд"
                '''
            }
        }
        stage("For testing") {
            steps {
                sh '''
                pwd
                '''
            }
        }
    }
    post { 
        always {
            script {
                if (getContext(hudson.FilePath)) {
                    deleteDir()
                }
            }
            withCredentials([string(credentialsId: 'tel_secret', variable: 'TOKEN'),string(credentialsId: 'tel_chat_id', variable: 'CHAT_ID')]) {
                sh """
                curl -s -X POST https://api.telegram.org/bot${TOKEN}/sendMessage -d chat_id=${CHAT_ID} -d parse_mode=markdown -d\
                text='*Отчёт:*\r
                *Project name :* ${currentBuild.projectName}\r
                *Version :* ${currentBuild.displayName}\r
                *Status :* ${currentBuild.result}'
                """
            }
            cleanWs()
        }
    }
}
