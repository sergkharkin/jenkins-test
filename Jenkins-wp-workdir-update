pipeline {
  agent {label 'inteliventi'}
  environment {
        EXTRA = ''
  }
  stages {
        stage("Checkout Git") {
            steps {
                git branch: 'prod', url: 'https://github.com/sergkharkin/jenkins-test.git' 
            }
        }
        stage("Deploy Wordpress") {
            steps {
                sh '''
                pwd
                sudo cp -r -f wp-docker /var/www/html2/
                ls -lah
                '''
            }
        }
        stage("Test site") {
            steps {
                sh '''#!/bin/bash
                set -x
                CURL_MAX_TIME=15
                STATUS_CODE=$(curl -sL -w "%{http_code}" localhost:8000 -o /dev/null --max-time ${CURL_MAX_TIME})
                if [[ "$STATUS_CODE" == "200" ]]; then
                    echo "Jenkins has come up and ready to use"
                    env.EXTRA = 'Good'
                else
                    echo "Jenkins did not recieved a correct status code"
                    echo "Returned: $STATUS_CODE"
                    #git revert HEAD~1
                    git branch: 'prod', url: 'https://github.com/sergkharkin/jenkins-test.git'
                    sudo cp -r -f wp-docker /var/www/html2/
                    env.EXTRA = 'Revert!'
                fi
                '''
            }
        }
    }
    post { 
        always {
            script {
                if (getContext(hudson.FilePath)) {
                    deleteDir()
                }
            }
            withCredentials([string(credentialsId: 'tel_secret', variable: 'TOKEN'),string(credentialsId: 'tel_chat_id', variable: 'CHAT_ID')]) {
                sh """
                curl -s -X POST https://api.telegram.org/bot${TOKEN}/sendMessage -d chat_id=${CHAT_ID} -d parse_mode=markdown -d\
                text='*Отчёт:*\r
                *Project name :* ${currentBuild.projectName}\r
                *Version :* ${currentBuild.displayName}\r
                *Status :* ${currentBuild.result} $EXTRA'
                """
            }
            cleanWs()
        }
    }
}
